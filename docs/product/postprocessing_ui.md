# 数据后处理 UI 产品设计文档

## 1. 产品目标

- 提供一个独立的、用户友好的 WebUI 标签页，专门用于对本地已存在的图像数据集进行批量后处理。
- 使用户能够方便地选择并应用 `waifuc` 库提供的多种图像处理动作 (Actions)，如调整尺寸、裁剪、过滤、自动打标等。
- 简化数据集在训练或其他用途前的准备工作，提高处理效率和灵活性。

## 2. 功能需求

### 2.1 核心功能

1.  **图像加载**:
    -   支持用户指定本地输入目录，从中加载图像进行处理。
    -   支持用户直接上传多个图像文件进行处理。
2.  **Action 选择**:
    -   动态列出可用的 `waifuc` Actions 供用户选择（例如：调整尺寸、裁剪、灰度化、标签过滤、图像去重等）。
    -   允许用户选择一个或多个 Actions 组成处理流水线。
3.  **Action 参数配置**:
    -   为用户选择的每个 Action 动态展示其可配置参数。
    -   提供用户友好的输入控件（如文本框、滑块、下拉菜单）进行参数设置。
4.  **处理与导出**:
    -   用户可以启动后处理任务。
    -   支持将处理后的图像保存到用户指定的本地输出目录。
    -   提供选项，决定是否覆盖原文件或保存到新位置。
5.  **结果预览与反馈**:
    -   （可选）提供处理后部分图像的预览功能。
    -   清晰显示处理进度和结果信息（成功数量、失败数量、错误日志等）。

### 2.2 用户交互

-   界面布局清晰，分为输入区、Action 选择与配置区、输出区和控制区。
-   Action 的参数配置区域根据用户的选择动态更新。
-   提供明确的“开始处理”按钮。
-   处理过程中应有进度条或状态提示。

## 3. 界面设计

### 3.1 主界面布局

-   **顶部区域**: 标签页标题“数据后处理”。
-   **左侧/上半部分 - 输入与配置区**:
    1.  **输入源选择**:
        -   选项卡或单选按钮：“处理目录” / “处理上传文件”。
        -   “处理目录”时：
            -   输入目录路径文本框。
            -   “浏览...”按钮选择目录。
        -   “处理上传文件”时：
            -   Gradio 的 `gr.Files` 组件用于上传。
    2.  **Action 选择区**:
        -   `gr.CheckboxGroup` 或类似组件，列出所有可用的后处理 Actions。
    3.  **Action 参数配置区**:
        -   动态生成区域，根据用户在 Action 选择区勾选的 Actions，显示对应的参数输入控件。每个 Action 的参数组应有清晰的标题。
    4.  **输出配置区**:
        -   输出目录路径文本框。
        -   “浏览...”按钮选择目录。
        -   （可选）`gr.Checkbox` “是否在输出文件名中添加后缀以避免覆盖”。
-   **右侧/下半部分 - 控制与输出区**:
    1.  **控制按钮**:
        -   `gr.Button` “开始处理”。
    2.  **进度与状态显示**:
        -   `gr.Progress` 进度条。
        -   `gr.Textbox` (只读, 多行) 或 `gr.HTML` 用于显示处理日志和摘要信息。
    3.  **结果预览区 (可选)**:
        -   `gr.Gallery` 用于展示少量处理前后的对比图像或处理后的图像。

### 3.2 界面原型 (组件描述)

| 区域             | 组件类型 (Gradio)        | 功能描述                                     |
| ---------------- | ------------------------ | -------------------------------------------- |
| 输入目录         | `gr.Textbox`             | 用户输入或选择的图像源文件夹路径             |
| 上传文件         | `gr.Files`               | 用户上传一个或多个图像文件                   |
| Action 选择      | `gr.CheckboxGroup`       | 列出可用的 Actions，供用户多选               |
| Action 参数      | 动态生成的各类输入组件   | 根据所选 Action 及其参数类型动态生成         |
| 输出目录         | `gr.Textbox`             | 用户输入或选择的处理结果保存文件夹路径         |
| 开始处理按钮     | `gr.Button`              | 触发后处理流程                               |
| 进度条           | `gr.Progress`            | 显示当前处理进度                             |
| 日志/状态输出    | `gr.Textbox` / `gr.HTML` | 显示处理过程中的信息、成功、失败和错误等     |
| 图像预览 (可选)  | `gr.Gallery`             | 展示处理前后的图像样本                       |

## 4. 用户数据收集

-   **输入数据**:
    -   用户指定的输入目录路径或上传的文件列表。
    -   选择的 Actions 列表。
    -   为每个 Action 配置的参数值。
    -   用户指定的输出目录路径。
-   **数据存储**:
    -   用户的配置信息仅在当前 WebUI 会话中有效，用于执行该次处理任务。
    -   不涉及用户历史记录的永久存储。

## 5. 技术设计 (高阶概述)

-   **前端界面**: 使用 Gradio 构建交互界面。
-   **后端逻辑**: Python 函数。
    -   动态扫描并加载 `waifuc.action` 中可用的 `BaseAction` 子类。
    -   根据用户选择和配置，实例化 `waifuc.LocalSource` (针对目录) 或直接处理上传的 PIL 图像列表。
    -   将选择的 Actions 及其配置应用于图像数据。
    -   使用 `waifuc.export.SaveExporter` 或类似机制保存处理后的图像。

## 6. 开发计划 (高阶)

1.  **阶段一**: 搭建基础 Gradio 界面框架，包括输入（目录）、Action 选择（静态列表）、输出目录和开始按钮。
2.  **阶段二**: 实现动态加载 `waifuc` Actions 并在 UI 中展示的功能。
3.  **阶段三**: 实现根据用户选择的 Actions 动态生成参数配置界面的功能。
4.  **阶段四**: 开发核心的图像后处理 Python 函数，该函数能接收图像源、Action 配置并执行处理。
5.  **阶段五**: 将后端处理逻辑与 Gradio 界面集成，实现文件上传处理、进度反馈和结果展示。
6.  **阶段六**: 进行全面的测试、错误处理和用户体验优化。

## 7. 预期成果

-   一个功能完整、操作简便的“数据后处理”Gradio 标签页。
-   用户能够通过该界面高效地对本地图像数据集应用 `waifuc` 的各种处理功能。
-   为整个 `dataset-cat` 项目提供强大的数据集预处理能力。